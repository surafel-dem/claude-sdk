# Research Agent - Complete Flow & State Machine Analysis

## Overview

This document provides a complete analysis of the research agent flow from user input to report generation, including state machine diagrams for each component and identification of current gaps.

---

## ğŸ”„ Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER INTERFACE                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  ChatInput  â”‚â”€â”€â”€â”€â–¶â”‚  MainApp    â”‚â”€â”€â”€â”€â–¶â”‚     MessageContent          â”‚   â”‚
â”‚   â”‚  Component  â”‚     â”‚  (State)    â”‚     â”‚  â”œâ”€â”€ Text (Markdown)        â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”œâ”€â”€ ActivityGroup          â”‚   â”‚
â”‚                             â”‚              â”‚  â”œâ”€â”€ ArtifactCard â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”‚â”€ Click opens panel
â”‚                             â”‚              â”‚  â””â”€â”€ StatusIndicator        â”‚   â”‚
â”‚                             â–¼              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                       â”‚ ArtifactPanelâ”‚â—€â”€â”€ Opens when artifact received       â”‚
â”‚                       â”‚  (Side Panel)â”‚                                       â”‚
â”‚                       â”‚  - View      â”‚                                       â”‚
â”‚                       â”‚  - Edit      â”‚                                       â”‚
â”‚                       â”‚  - Approve   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                             â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            BACKEND API                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   POST /api/chat                    GET /api/stream/:runId                   â”‚
â”‚   â”œâ”€â”€ Receive message               â”œâ”€â”€ SSE Stream                          â”‚
â”‚   â”œâ”€â”€ Create runId                  â”œâ”€â”€ Events:                             â”‚
â”‚   â””â”€â”€ Store in sessions             â”‚   - text: LLM response text           â”‚
â”‚                                     â”‚   - phase: Status update              â”‚
â”‚                                     â”‚   - status: Tool status               â”‚
â”‚                                     â”‚   - tool: Tool usage                  â”‚
â”‚                                     â”‚   - artifact: Plan/Report             â”‚
â”‚                                     â”‚   - done: Complete                    â”‚
â”‚                                     â”‚   - error: Error message              â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HYBRID AGENT                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      hybridAgent()                                   â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  Phase 1: Orchestrator (Direct LLM)                                  â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Receives user prompt                                            â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Generates plan (if research needed)                             â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Emits: orchestrator_text, artifact (plan)                       â”‚   â”‚
â”‚   â”‚  â””â”€â”€ Detects: [EXECUTE_RESEARCH] â†’ needs_sandbox = true              â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  Phase 2: Researcher (E2B Sandbox) - Only if needs_sandbox           â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Creates/resumes sandbox                                         â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Uploads plan.md to sandbox                                      â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Runs agent.mjs script                                           â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Agent uses: WebSearch, Write                                    â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Emits: status, tool, researcher_text                            â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Downloads report.md from sandbox                                â”‚   â”‚
â”‚   â”‚  â””â”€â”€ Emits: artifact (report)                                        â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  Phase 3: Summary (Direct LLM) - Only if research ran                â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€ Receives report.md content                                      â”‚   â”‚
â”‚   â”‚  â””â”€â”€ Emits: summary_text                                             â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CONVEX (Database)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Threads                      Messages                   Artifacts          â”‚
â”‚   â”œâ”€â”€ id                       â”œâ”€â”€ threadId              â”œâ”€â”€ threadId        â”‚
â”‚   â”œâ”€â”€ userId                   â”œâ”€â”€ role                  â”œâ”€â”€ type            â”‚
â”‚   â”œâ”€â”€ title                    â”œâ”€â”€ content               â”œâ”€â”€ title           â”‚
â”‚   â””â”€â”€ createdAt                â”œâ”€â”€ artifactIds[]         â”œâ”€â”€ content         â”‚
â”‚                                â””â”€â”€ createdAt             â”œâ”€â”€ status          â”‚
â”‚                                                          â””â”€â”€ createdAt       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ State Machine Diagrams

### 1. Main App State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    MainApp                          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    IDLE       â”‚                           â”‚  LOADING      â”‚
            â”‚               â”‚                           â”‚               â”‚
            â”‚ - No messages â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ - isLoading   â”‚
            â”‚ - Input empty â”‚          done/error       â”‚ - Streaming   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                           â–²
                    â”‚ handleSubmit()                            â”‚
                    â”‚ or handleApproval()                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    
States:
- IDLE: User can type, no streaming
- LOADING: SSE stream active, collecting parts

Transitions:
- IDLE â†’ LOADING: User submits message or approves plan
- LOADING â†’ IDLE: SSE 'done' or 'error' event received
```

### 2. Message Stream State Machine

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                    SSE Event Stream                          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ text          â”‚         â”‚ status/phase  â”‚         â”‚ artifact      â”‚
    â”‚               â”‚         â”‚               â”‚         â”‚               â”‚
    â”‚ Append to     â”‚         â”‚ Show shimmer  â”‚         â”‚ Create card   â”‚
    â”‚ currentParts  â”‚         â”‚ indicator     â”‚         â”‚ Auto-open     â”‚
    â”‚ as 'text'     â”‚         â”‚ as 'activity' â”‚         â”‚ panel         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                         â”‚                         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ done/error    â”‚
                              â”‚               â”‚
                              â”‚ Flush parts   â”‚
                              â”‚ to messages   â”‚
                              â”‚ Clear loading â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Artifact Lifecycle State Machine

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   START     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ Orchestrator creates plan
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   DRAFT     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚             â”‚                          â”‚
                              â”‚ Plan awaits â”‚        User rejects      â”‚
                              â”‚ approval    â”‚                          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
                                    â”‚                                  â”‚
                                    â”‚ User approves                    â”‚
                                    â–¼ (button or chat)                 â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
                              â”‚  APPROVED   â”‚                          â”‚
                              â”‚             â”‚                          â”‚
                              â”‚ Triggers    â”‚                          â”‚
                              â”‚ research    â”‚                          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
                                    â”‚                                  â”‚
                                    â”‚ Sandbox executes                 â”‚
                                    â–¼                                  â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
                              â”‚ RESEARCHING â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚             â”‚        Error/Timeout
                              â”‚ Agent runs  â”‚
                              â”‚ in sandbox  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Agent writes report.md
                                    â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  COMPLETE   â”‚
                              â”‚             â”‚
                              â”‚ Report      â”‚
                              â”‚ artifact    â”‚
                              â”‚ created     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Hybrid Agent Phase State Machine

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                    hybridAgent()                             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   PHASE 1:    â”‚
                              â”‚ ORCHESTRATOR  â”‚
                              â”‚               â”‚
                              â”‚ - Direct LLM  â”‚
                              â”‚ - Creates planâ”‚
                              â”‚ - Emits text  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚                 â”‚
                    â–¼                 â–¼                 â–¼
            [EXECUTE_RESEARCH]   Simple chat       Approval
            detected             (go to done)      detected
                    â”‚                 â”‚                 â”‚
                    â–¼                 â”‚                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   PHASE 2:    â”‚         â”‚         â”‚   PHASE 2:    â”‚
            â”‚  RESEARCHER   â”‚         â”‚         â”‚  RESEARCHER   â”‚
            â”‚               â”‚         â”‚         â”‚               â”‚
            â”‚ - E2B Sandbox â”‚         â”‚         â”‚ - E2B Sandbox â”‚
            â”‚ - WebSearch   â”‚         â”‚         â”‚ - WebSearch   â”‚
            â”‚ - Write reportâ”‚         â”‚         â”‚ - Write reportâ”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚                 â”‚
                    â–¼                 â”‚                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   PHASE 3:    â”‚         â”‚         â”‚   PHASE 3:    â”‚
            â”‚   SUMMARY     â”‚         â”‚         â”‚   SUMMARY     â”‚
            â”‚               â”‚         â”‚         â”‚               â”‚
            â”‚ - Summarize   â”‚         â”‚         â”‚ - Summarize   â”‚
            â”‚   report      â”‚         â”‚         â”‚   report      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚     DONE      â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. Artifact Panel State Machine

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   CLOSED    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                    â”‚                         â”‚
                                    â”‚ User clicks             â”‚ User clicks X
                                    â”‚ ArtifactCard            â”‚ or outside
                                    â–¼                         â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
                              â”‚   VIEWING   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â”‚             â”‚                 â”‚
                              â”‚ Shows       â”‚                 â”‚
                              â”‚ artifact    â”‚                 â”‚
                              â”‚ content     â”‚                 â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                    â”‚                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                    â”‚               â”‚               â”‚         â”‚
                    â–¼               â–¼               â”‚         â”‚
            User clicks      User clicks           â”‚         â”‚
            "Edit"           "Approve"             â”‚         â”‚
                    â”‚               â”‚               â”‚         â”‚
                    â–¼               â–¼               â”‚         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚         â”‚
            â”‚   EDITING     â”‚ â”‚  APPROVING    â”‚     â”‚         â”‚
            â”‚               â”‚ â”‚               â”‚     â”‚         â”‚
            â”‚ Textarea      â”‚ â”‚ Sends message â”‚     â”‚         â”‚
            â”‚ active        â”‚ â”‚ to backend    â”‚     â”‚         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚         â”‚
                    â”‚               â”‚               â”‚         â”‚
                    â”‚ Save          â”‚ Complete      â”‚         â”‚
                    â–¼               â–¼               â”‚         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚         â”‚
            â”‚   VIEWING     â”‚ â”‚   CLOSED      â”‚â—€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Identified Gaps

### Gap 1: Report Artifact Not Appearing as Card

**Location**: `researcherExecute()` â†’ `artifact` event â†’ Frontend
**Issue**: Report artifact is emitted but not shown as clickable card
**Cause**:

- `maxTurns: 3` may be too low for agent to complete Write operation
- Or report.md is not being written in sandbox

**Current Flow**:

```
Researcher â†’ (may timeout) â†’ No report.md â†’ No artifact emitted
```

**Expected Flow**:

```
Researcher â†’ Write report.md â†’ Download â†’ Emit artifact â†’ Show card
```

### Gap 2: Status Updates During Initial Chat

**Location**: `hybridAgent()`
**Issue**: Was showing "Planning..." for simple "hello" messages
**Status**: âœ… FIXED - Removed static status emission

### Gap 3: APPROVED: Message Leaking to UI

**Location**: `MessageContent.cleanText()`
**Issue**: Internal approval message showing in chat
**Status**: âœ… FIXED - Improved regex filtering

### Gap 4: Artifact Card Subtext

**Location**: `ArtifactCard` component
**Issue**: Shows "Plan" instead of "Waiting for approval"
**Status**: âœ… FIXED - Added `getSubtext()` helper

### Gap 5: Summary Shows Instead of Report

**Location**: Phase 3 in `hybridAgent()`
**Issue**: Orchestrator summary text streams, but no Report artifact card
**Root Cause**: Report artifact event may not be reaching frontend

---

## ğŸ“‹ Component Inventory

### Frontend Components

| Component | Purpose | State | Events Handled |
|-----------|---------|-------|----------------|
| `MainApp` | Main container | messages, currentParts, isLoading, activeArtifact | submit, approval |
| `ChatInput` | User input | value, loading | onChange, onSubmit |
| `MessageContent` | Render message parts | parts, streaming | artifactClick |
| `ArtifactCard` | Clickable artifact pill | artifact data | onClick |
| `ArtifactPanel` | Side panel for viewing | artifact, editing, approving | close, edit, save, approve |
| `StatusIndicator` | Shimmer status | activities | - |
| `Sidebar` | Thread list | threads, active | new, select, delete |

### Backend Functions

| Function | Purpose | Input | Output Events |
|----------|---------|-------|---------------|
| `hybridAgent()` | Main orchestration | prompt, history | all event types |
| `orchestratorChat()` | LLM planning | prompt, history | text, artifact, needs_sandbox |
| `researcherExecute()` | Sandbox execution | task, sessionId | status, tool, text, artifact |
| `chatMode()` | Simple Q&A | prompt, history | text |

### SSE Event Types

| Event | Source | Purpose |
|-------|--------|---------|
| `text` | orchestrator, researcher, summary | Streaming text content |
| `phase` | hybrid | Major phase change (removed) |
| `status` | researcher | Tool/progress status |
| `tool` | researcher | Tool usage notification |
| `artifact` | orchestrator, researcher | Plan or Report data |
| `done` | hybrid | Stream complete |
| `error` | any | Error occurred |

---

## ğŸ”§ Recommended Fixes

### Fix 1: Ensure Report Artifact Reaches Frontend

```typescript
// In hybrid.ts - Add logging
yield { type: 'artifact', content: JSON.stringify({ ... }) };
console.log('[Artifact Event] Report emitted'); // Add this
```

### Fix 2: Increase maxTurns for Report Writing

```typescript
// In generateScript()
maxTurns: 5,  // Increase from 3 to 5
```

### Fix 3: Frontend Artifact Auto-Open for Reports

```typescript
// Already implemented - verify it works
if (data.convexId) {
  setActiveArtifact({ id: data.convexId, artifact: streamingArtifact });
}
```

### Fix 4: Add Report Fallback

```typescript
// If no report.md, still emit summary as artifact
if (!report) {
  yield {
    type: 'artifact',
    content: JSON.stringify({
      type: 'report',
      title: 'Research Summary',
      content: summaryText,
    })
  };
}
```
